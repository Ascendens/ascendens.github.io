---
extends: _layouts.post
permalink: kak-zadat-proizvolnuyu-komponovku-filtrov-v-sphinx.html
title: Как задать произвольную компоновку фильтров в Sphinx
date: 2014-02-03 11:53:53
---

Когда я получил задание, связанное с поисковой системой Sphinx, то оказалось, что в Sphinx все фильтры компонуются 
исключительно через условие `И`. Мне же понадобилась компоновка через `ИЛИ`, причем сложная. О своем варианте решения 
данного вопроса я сегодня и расскажу.

<!--more-->

Итак, речь пойдет о Sphinx'е. Что это такое можно узнать, например, [здесь](http://ru.wikipedia.org/wiki/Sphinx_(%D0%BF%D0%BE%D0%B8%D1%81%D0%BA%D0%BE%D0%B2%D0%B0%D1%8F_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0)) 
или [здесь](http://sphinxsearch.com/). Никаких инструкций об установке и 
настройке поисковой систему куда-либо или как-либо не будет, увы. Рассматривать работу мы будем на базе методов класса 
sfSphinxClient — часть пакета sfSphinxPlugin для Symfony 1.4

Основными инструментами поиска в Sphinx являются [запросы](http://sphinxsearch.com/docs/archives/1.10/extended-syntax.html)
и [фильтры](http://www.php.net/manual/ru/sphinxclient.setfilter.php). К моему разочарованию, через методы фильтры нельзя
компоновать с разными логическими условиями, например, `(условие1 И условие2) ИЛИ условие3`. Если вы задали фильтр, то
все последущие setFilter при поиске будут сравниваться через `И`. Часто, такое поведение не дает решить поставленную
задачу.

Что же делать, чтобы **заставить фильтры в Sphinx работать через `ИЛИ`**? Решение в методе [SetSelect](http://sphinxsearch.com/docs/archives/1.10/api-func-setselect.html).
Через него можно задать произвольную выборку данных из существующего индекса, подобно тому, как это делается в базах
данных. В нашем случае, ключевой является возможность использовать конструкцию `IF`:

```
IF(a <= 2 OR b >= 5, 1, 0) AS cf
```

"Чудесно, что можно делать произвольные выборки, но чем это может помочь?", &mdash; спросите вы. А тем, что теперь мы можем
задать фильтр по результату условия в `SELECT cf` в вышеуказанном примере) и получить желаемый результат. Давайте
рассмотрим фрагмент кода, демонстрирующий **сложную компоновку фильтров в Sphinx**, более наглядно.

```php
// Инициализация клиента
$sphinx = new sfSphinxClient(array('offset' => 0, 'limit' => 1));
// Определяем сложный фильтр
$sphinx->SetSelect('*, IF((a >= 2 OR b <= 5) OR (c != 0 AND c = 10), 1, 0) AS cf');
// Именно здесь мы применяем сложный фильтр к выборке. Обязательно без @ и прочих специальных символов!!!
$sphinx->SetFilter('cf', array(1));
// Получаем результат
$result = $sphinx->getRes();
```

Можно, также, использовать несколько <code>IF</code> в одном <code>SELECT</code> &mdash; разделяются запятой и должны , и даже проводить над
результатами различные операции, например:

```
IF(a >= 2 OR b <= 5, 1, 0) + IF(c != 0 AND c = 10, 5, 0)
```

Достаточно гибко, хотя наглядная компоновка фильтров, как в том же Elasticsearch, по-моему, для неискушенных удобнее.
